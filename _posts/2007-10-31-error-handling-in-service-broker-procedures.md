---
id: 56
title: Error Handling in Service Broker procedures
date: 2007-10-31T18:13:30+00:00
author: remus
layout: post
guid: http://rusanu.com/2007/10/31/error-handling-in-service-broker-procedures/
permalink: /2007/10/31/error-handling-in-service-broker-procedures/
categories:
  - Tutorials
tags:
  - error
  - sample
  - service broker
---
<p __designer:dtid="844424930131968">Error handling in T-SQL traditionally has been a sort of misterious voo-doo for most developers, with it&#8217;s mixture of <a __designer:dtid="844424930131969" href="http://msdn2.microsoft.com/en-us/library/ms164086.aspx">error severities</a>, SET settings like <a _\_designer:dtid="844424930131970" href="http://msdn2.microsoft.com/en-us/library/ms188792.aspx">XACT\_ABORT</a>, <a __designer:dtid="844424930131971" href="http://msdn2.microsoft.com/en-us/library/ms190306.aspx">ARITHABORT</a> or <a __designer:dtid="844424930131972" href="http://msdn2.microsoft.com/en-us/library/ms184341.aspx">ARITHIGNORE</a> and the options to handle the error on the server or at the client. For a long time now the best resource I know on this subject was, and perhaps still is, Erland Sommarskog set of articles at<a __designer:dtid="844424930131973" href="http://www.sommarskog.se/error-handling-I.html"> http://www.sommarskog.se/error-handling-I.html</a> and <a __designer:dtid="844424930131974" href="http://www.sommarskog.se/error-handling-II.html">http://www.sommarskog.se/error-handling-II.html</a>. But the introduction of Service Broker activated procedures adds some new issues to consider when designing your application and this post is about what these issues are these and how to best cope with them. <br __designer:dtid="844424930131975" /></p> 

<!--more--><h2 __designer:dtid="844424930131976">@@ERROR or TRY&#8230;CATCH?</h2> <p __designer:dtid="844424930131977">Well first things first, lets get this out of our way: check <a __designer:dtid="844424930131978" href="http://msdn2.microsoft.com/en-us/library/ms190193.aspx">@@error</a> or use <a __designer:dtid="844424930131979" href="http://msdn2.microsoft.com/en-us/library/ms179296.aspx">BEGIN TRY&#8230; BEGIN CATCH</a>? In my opinion, the advantages offered by the TRY&#8230; CATCH blocks are overwhelming and you should steer away from checking @@ERROR after each statement. Even if you may find some immediate scenario that would seem simpler using an explicit check for @@error, writing code using TRY&#8230;CATCH blocks pays of on the long run. For me the most important differentiatin factor between the two is actually the human factor: code writen with @@error checks is difficult to read and impossible to maintain. Keeping the discipline in writing code to check for @@error after each statement is tedious and errorprone. @@error checks are not &#8216;<a _\_designer:dtid="844424930131980" href="http://www.amazon.com/Effective-C%2B%2B-Addison-Wesley-Professional-Computing/dp/0321334876/ref=pd\_bbs\_sr\_1/002-9386102-7810448?ie=UTF8&s=books&qid=1193824559&sr=8-1">programming in the future tense</a>&#8216; as Scott Meyers would put it: future versions in the database engine could introduce behavior changes that raise new errors your application is not prepared to deal with. The TRY&#8230;CATCH blocks solve so many of these issues that they are clearly the winner in my book.</p> <h2 __designer:dtid="844424930131981">Service Broker Error Handling</h2> <p __designer:dtid="844424930131982">Why is Service Broker error handling something special? Shouldn&#8217;t the normal common wisdom of writing Transact-SQL apply to Service Broker as well? Well yes, but as it turns out there is a twist to the story. Service Broker is an integrated part of the SQL Server database engine and it follows all the normal Transact-SQL language parsing, compilation and execution rules like any other database engine componet, including everything related to errors and exception handling. But the typical Service Broker application is deployed in a quite different fashion than the non-broker applications: it&#8217;s an activated procedure that runs in the server background threads. The first major difference is that there is no client application to surface the error to, so any error that happens will have to be dealt with by the procedure. This means that the very purpose of error handling in a Service Broker application is different than in an ordinary procedure: Service Broker error handling has to capture <em __designer:dtid="844424930131983">any</em> error and somehow react to this error at the level of Service Broker semantics, namely conversations. Most times this means that the conversation that received the message that triggered the error has to be ended with an error so that the partener service is notified about this problem and, sometimes, some compensation logic has to be run to undo the effects of this conversation had so far. The partener will receive the error message and in turn run its own compensation to complete (with error) the business transaction represented by the conversation..</p> <p __designer:dtid="844424930131984">Lets roll a quick example. Supose we have a trivial service whose role is to insert received message content into a target table (similar to what an audit service perhaps would do). Lets go ahead and build our DDL objects:</p> <p __designer:dtid="844424930131985" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930131986" style="font-size: 10pt; color: blue; font-family: 'Courier New'">use</span><span __designer:dtid="844424930131987" style="font-size: 10pt; font-family: 'Courier New'"> tempdb<span __designer:dtid="844424930131988" style="color: gray">;

<!--l namespace="" ns="urn:schemas-microsoft-com:office:office"                      prefix="o"--></span></span></p> <p __designer:dtid="844424930131990" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930131991" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930131993" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930131994" style="font-size: 10pt; font-family: 'Courier New'">        </span></p> <p __designer:dtid="844424930131996" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930131997" style="font-size: 10pt; color: green; font-family: 'Courier New'">&#8212; A table for the purpose of the demo</span></p> <p __designer:dtid="844424930131999" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132000" style="font-size: 10pt; color: blue; font-family: 'Courier New'">create</span><span __designer:dtid="844424930132001" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132002" style="color: blue">table</span> [target_table] <span __designer:dtid="844424930132003" style="color: gray">(</span></span></p> <p __designer:dtid="844424930132005" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132006" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132007">      </span>[id] <span __designer:dtid="844424930132008" style="color: blue">int</span> <span __designer:dtid="844424930132009" style="color: gray">not</span> <span __designer:dtid="844424930132010" style="color: gray">null</span> <span __designer:dtid="844424930132011" style="color: blue">primary</span> <span __designer:dtid="844424930132012" style="color: blue">key</span><span __designer:dtid="844424930132013" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132015" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132016" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132017">      </span>[key] <span __designer:dtid="844424930132018" style="color: blue">nvarchar</span><span __designer:dtid="844424930132019" style="color: gray">(</span>256<span __designer:dtid="844424930132020" style="color: gray">),</span></span></p> <p __designer:dtid="844424930132022" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132023" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132024">      </span>[value] <span __designer:dtid="844424930132025" style="color: blue">nvarchar</span><span __designer:dtid="844424930132026" style="color: gray">(</span>256<span __designer:dtid="844424930132027" style="color: gray">));</span></span></p> <p __designer:dtid="844424930132029" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132030" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930132032" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132033" style="font-size: 10pt; font-family: 'Courier New'">        </span></p> <p __designer:dtid="844424930132035" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132036" style="font-size: 10pt; color: green; font-family: 'Courier New'">&#8212; Our initiator service</span></p> <p __designer:dtid="844424930132038" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132039" style="font-size: 10pt; color: blue; font-family: 'Courier New'">create</span><span __designer:dtid="844424930132040" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132041" style="color: blue">queue</span> [sender_queue]<span __designer:dtid="844424930132042" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132044" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132045" style="font-size: 10pt; color: blue; font-family: 'Courier New'">create</span><span __designer:dtid="844424930132046" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132047" style="color: blue">service</span> [sender_service]</span></p> <p __designer:dtid="844424930132049" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132050" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132051">      </span><span __designer:dtid="844424930132052" style="color: blue">on</span> <span __designer:dtid="844424930132053" style="color: blue">queue</span> [sender_queue]<span __designer:dtid="844424930132054" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132056" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132057" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930132059" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132060" style="font-size: 10pt; font-family: 'Courier New'">        </span></p> <p __designer:dtid="844424930132062" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132063" style="font-size: 10pt; color: green; font-family: 'Courier New'">&#8212; Our target service</span></p> <p __designer:dtid="844424930132065" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132066" style="font-size: 10pt; color: blue; font-family: 'Courier New'">create</span><span __designer:dtid="844424930132067" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132068" style="color: blue">queue</span> [target_queue]<span __designer:dtid="844424930132069" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132071" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132072" style="font-size: 10pt; color: blue; font-family: 'Courier New'">create</span><span __designer:dtid="844424930132073" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132074" style="color: blue">service</span> [target_service]</span></p> <p __designer:dtid="844424930132076" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132077" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132078">      </span><span __designer:dtid="844424930132079" style="color: blue">on</span> <span __designer:dtid="844424930132080" style="color: blue">queue</span> [target_queue]</span></p> <p __designer:dtid="844424930132082" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132083" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132084">      </span><span __designer:dtid="844424930132085" style="color: gray">(</span>[DEFAULT]<span __designer:dtid="844424930132086" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132088" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132089" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930132091" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132092" style="font-size: 10pt; font-family: 'Courier New'">        </span></p> 

<span __designer:dtid="844424930132094" style="font-size: 10pt; color: green; font-family: 'Courier New'"></span><span __designer:dtid="844424930132094" style="font-size: 10pt; color: green; font-family: 'Courier New'"></span><span __designer:dtid="844424930132094" style="font-size: 10pt; color: green; font-family: 'Courier New'"></span><span __designer:dtid="844424930132094" style="font-size: 10pt; color: green; font-family: 'Courier New'"></span><span __designer:dtid="844424930132094" style="font-size: 10pt; color: green; font-family: 'Courier New'"><p __designer:dtid="844424930132095" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132096" style="font-size: 10pt; color: blue; font-family: 'Courier New'">create</span><span __designer:dtid="844424930132097" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132098" style="color: #000000"> </span><span __designer:dtid="844424930132099" style="color: blue">procedure</span><span _\_designer:dtid="844424930132100" style="color: #000000"> [usp\_target]</span></span></p> <p __designer:dtid="844424930132102" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132103" style="font-size: 10pt; color: blue; font-family: 'Courier New'">as</span></p> <p __designer:dtid="844424930132105" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132106" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span></p> <p __designer:dtid="844424930132108" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132109" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132110" style="color: #000000">      </span><span __designer:dtid="844424930132111" style="color: blue">set</span><span __designer:dtid="844424930132112" style="color: #000000"> </span><span __designer:dtid="844424930132113" style="color: blue">nocount</span><span __designer:dtid="844424930132114" style="color: #000000"> </span><span __designer:dtid="844424930132115" style="color: blue">on</span><span __designer:dtid="844424930132116" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132118" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132119" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132120" style="color: #000000">      </span><span __designer:dtid="844424930132121" style="color: blue">declare</span><span __designer:dtid="844424930132122" style="color: #000000"> @handle </span><span __designer:dtid="844424930132123" style="color: blue">uniqueidentifier</span><span __designer:dtid="844424930132124" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132126" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132127" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132128" style="color: #000000">      </span><span __designer:dtid="844424930132129" style="color: blue">declare</span><span __designer:dtid="844424930132130" style="color: #000000"> @messageType </span><span __designer:dtid="844424930132131" style="color: blue">sysname</span><span __designer:dtid="844424930132132" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132134" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132135" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132136" style="color: #000000">      </span><span __designer:dtid="844424930132137" style="color: blue">declare</span><span __designer:dtid="844424930132138" style="color: #000000"> @payload </span><span __designer:dtid="844424930132139" style="color: blue">xml</span><span __designer:dtid="844424930132140" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132142" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132143" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132144" style="color: #000000">      </span></span></p> <p __designer:dtid="844424930132146" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132147" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132148" style="color: #000000">      </span><span __designer:dtid="844424930132149" style="color: blue">begin</span><span __designer:dtid="844424930132150" style="color: #000000"> </span><span __designer:dtid="844424930132151" style="color: blue">try</span></span></p> <p __designer:dtid="844424930132153" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132154" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132155" style="color: #000000">            </span><span __designer:dtid="844424930132156" style="color: blue">begin</span><span __designer:dtid="844424930132157" style="color: #000000"> </span><span __designer:dtid="844424930132158" style="color: blue">transaction</span><span __designer:dtid="844424930132159" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132161" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132162" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132163" style="color: #000000">            </span><span __designer:dtid="844424930132164" style="color: blue">waitfor</span><span __designer:dtid="844424930132165" style="color: #000000"> </span><span __designer:dtid="844424930132166" style="color: gray">(</span><span __designer:dtid="844424930132167" style="color: blue">receive</span><span __designer:dtid="844424930132168" style="color: #000000"> </span><span __designer:dtid="844424930132169" style="color: blue">top</span><span __designer:dtid="844424930132170" style="color: #000000"> </span><span __designer:dtid="844424930132171" style="color: gray">(</span><span __designer:dtid="844424930132172" style="color: #000000">1</span><span __designer:dtid="844424930132173" style="color: gray">)</span></span></p> <p __designer:dtid="844424930132175" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132176" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132177" style="color: #000000">                  </span><span __designer:dtid="844424930132178" style="color: #000000">@handle </span><span __designer:dtid="844424930132179" style="color: gray">=</span><span __designer:dtid="844424930132180" style="color: #000000"> </span><span _\_designer:dtid="844424930132181" style="color: blue">conversation\_handle</span><span __designer:dtid="844424930132182" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132184" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132185" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132186" style="color: #000000">                  </span><span __designer:dtid="844424930132187" style="color: #000000">@messageType </span><span __designer:dtid="844424930132188" style="color: gray">=</span><span _\_designer:dtid="844424930132189" style="color: #000000"> message\_type_name</span><span __designer:dtid="844424930132190" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132192" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132193" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132194" style="color: #000000">                  </span><span __designer:dtid="844424930132195" style="color: #000000">@payload </span><span __designer:dtid="844424930132196" style="color: gray">=</span><span __designer:dtid="844424930132197" style="color: #000000"> </span><span __designer:dtid="844424930132198" style="color: fuchsia">cast</span><span __designer:dtid="844424930132199" style="color: gray">(</span><span _\_designer:dtid="844424930132200" style="color: #000000">message\_body </span><span __designer:dtid="844424930132201" style="color: blue">as</span><span __designer:dtid="844424930132202" style="color: #000000"> </span><span __designer:dtid="844424930132203" style="color: blue">xml</span><span __designer:dtid="844424930132204" style="color: gray">)</span></span></p> <p __designer:dtid="844424930132206" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132207" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132208" style="color: #000000">                  </span><span __designer:dtid="844424930132209" style="color: blue">from</span><span _\_designer:dtid="844424930132210" style="color: #000000"> [target\_queue]</span><span __designer:dtid="844424930132211" style="color: gray">),</span><span __designer:dtid="844424930132212" style="color: #000000"> </span><span __designer:dtid="844424930132213" style="color: blue">timeout</span><span __designer:dtid="844424930132214" style="color: #000000"> 1000</span><span __designer:dtid="844424930132215" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132217" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132218" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132219" style="color: #000000">            </span><span __designer:dtid="844424930132220" style="color: blue">if</span><span __designer:dtid="844424930132221" style="color: #000000"> </span><span __designer:dtid="844424930132222" style="color: gray">(</span><span __designer:dtid="844424930132223" style="color: #000000">0 </span><span __designer:dtid="844424930132224" style="color: gray">!=</span><span __designer:dtid="844424930132225" style="color: #000000"> </span><span __designer:dtid="844424930132226" style="color: fuchsia">@@rowcount</span><span __designer:dtid="844424930132227" style="color: gray">)</span></span></p> <p __designer:dtid="844424930132229" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132230" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132231" style="color: #000000">            </span><span __designer:dtid="844424930132232" style="color: blue">begin</span></span></p> <p __designer:dtid="844424930132234" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132235" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132236" style="color: #000000">                  </span><span __designer:dtid="844424930132237" style="color: blue">if</span><span __designer:dtid="844424930132238" style="color: #000000"> </span><span __designer:dtid="844424930132239" style="color: gray">(</span><span __designer:dtid="844424930132240" style="color: #000000">@messageType </span><span __designer:dtid="844424930132241" style="color: gray">=</span><span __designer:dtid="844424930132242" style="color: #000000"> </span><span __designer:dtid="844424930132243" style="color: red">&#8216;DEFAULT&#8217;</span><span __designer:dtid="844424930132244" style="color: gray">)</span></span></p> <p __designer:dtid="844424930132246" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132247" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132248" style="color: #000000">                  </span><span __designer:dtid="844424930132249" style="color: blue">begin</span></span></p> <p __designer:dtid="844424930132251" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132252" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132253" style="color: #000000">                        </span><span __designer:dtid="844424930132254" style="color: blue">insert</span><span __designer:dtid="844424930132255" style="color: #000000"> </span><span __designer:dtid="844424930132256" style="color: blue">into</span><span _\_designer:dtid="844424930132257" style="color: #000000"> [target\_table] </span><span __designer:dtid="844424930132258" style="color: gray">(</span></span></p> <p __designer:dtid="844424930132260" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132261" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132262" style="color: #000000">                              </span><span __designer:dtid="844424930132263" style="color: #000000">[id]</span><span __designer:dtid="844424930132264" style="color: gray">,</span><span __designer:dtid="844424930132265" style="color: #000000"> [key]</span><span __designer:dtid="844424930132266" style="color: gray">,</span><span __designer:dtid="844424930132267" style="color: #000000"> [value]</span><span __designer:dtid="844424930132268" style="color: gray">)</span><span __designer:dtid="844424930132269" style="color: #000000"> </span></span></p> <p __designer:dtid="844424930132271" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132272" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132273" style="color: #000000">                              </span><span __designer:dtid="844424930132274" style="color: blue">select</span><span __designer:dtid="844424930132275" style="color: #000000"> e</span><span __designer:dtid="844424930132276" style="color: gray">.</span><span __designer:dtid="844424930132277" style="color: #000000">value</span><span __designer:dtid="844424930132278" style="color: gray">(</span><span __designer:dtid="844424930132279" style="color: red">&#8216;@id&#8217;</span><span __designer:dtid="844424930132280" style="color: gray">,</span><span __designer:dtid="844424930132281" style="color: #000000"> </span><span __designer:dtid="844424930132282" style="color: red">&#8216;int&#8217;</span><span __designer:dtid="844424930132283" style="color: gray">)</span><span __designer:dtid="844424930132284" style="color: #000000"> </span><span __designer:dtid="844424930132285" style="color: blue">as</span><span __designer:dtid="844424930132286" style="color: #000000"> [id]</span><span __designer:dtid="844424930132287" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132289" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132290" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132291" style="color: #000000">                                    </span><span __designer:dtid="844424930132292" style="color: #000000">e</span><span __designer:dtid="844424930132293" style="color: gray">.</span><span __designer:dtid="844424930132294" style="color: #000000">value</span><span __designer:dtid="844424930132295" style="color: gray">(</span><span __designer:dtid="844424930132296" style="color: red">&#8216;@key&#8217;</span><span __designer:dtid="844424930132297" style="color: gray">,</span><span __designer:dtid="844424930132298" style="color: #000000"> </span><span __designer:dtid="844424930132299" style="color: red">&#8216;nvarchar(256)&#8217;</span><span __designer:dtid="844424930132300" style="color: gray">)</span><span __designer:dtid="844424930132301" style="color: #000000"> </span><span __designer:dtid="844424930132302" style="color: blue">as</span><span __designer:dtid="844424930132303" style="color: #000000"> [key]</span><span __designer:dtid="844424930132304" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132306" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132307" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132308" style="color: #000000">                                    </span><span __designer:dtid="844424930132309" style="color: #000000">e</span><span __designer:dtid="844424930132310" style="color: gray">.</span><span __designer:dtid="844424930132311" style="color: #000000">value</span><span __designer:dtid="844424930132312" style="color: gray">(</span><span __designer:dtid="844424930132313" style="color: red">&#8216;@value&#8217;</span><span __designer:dtid="844424930132314" style="color: gray">,</span><span __designer:dtid="844424930132315" style="color: #000000"> </span><span __designer:dtid="844424930132316" style="color: red">&#8216;nvarchar(256)&#8217;</span><span __designer:dtid="844424930132317" style="color: gray">)</span><span __designer:dtid="844424930132318" style="color: #000000"> </span><span __designer:dtid="844424930132319" style="color: blue">as</span><span __designer:dtid="844424930132320" style="color: #000000"> [value]</span></span></p> <p __designer:dtid="844424930132322" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132323" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132324" style="color: #000000">                                    </span><span __designer:dtid="844424930132325" style="color: blue">from</span><span __designer:dtid="844424930132326" style="color: #000000"> @payload</span><span __designer:dtid="844424930132327" style="color: gray">.</span><span __designer:dtid="844424930132328" style="color: #000000">nodes</span><span __designer:dtid="844424930132329" style="color: gray">(</span><span __designer:dtid="844424930132330" style="color: red">&#8216;//payload/entry&#8217;</span><span __designer:dtid="844424930132331" style="color: gray">)</span><span __designer:dtid="844424930132332" style="color: #000000"> p</span><span __designer:dtid="844424930132333" style="color: gray">(</span><span __designer:dtid="844424930132334" style="color: #000000">e</span><span __designer:dtid="844424930132335" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132337" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132338" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132339" style="color: #000000">                  </span><span __designer:dtid="844424930132340" style="color: blue">end</span><span __designer:dtid="844424930132341" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132343" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132344" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132345" style="color: #000000">                  </span><span __designer:dtid="844424930132346" style="color: blue">end</span><span __designer:dtid="844424930132347" style="color: #000000"> </span><span __designer:dtid="844424930132348" style="color: blue">conversation</span><span __designer:dtid="844424930132349" style="color: #000000"> @handle</span><span __designer:dtid="844424930132350" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132352" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132353" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132354" style="color: #000000">            </span><span __designer:dtid="844424930132355" style="color: blue">end</span><span __designer:dtid="844424930132356" style="color: #000000"> </span></span></p> <p __designer:dtid="844424930132358" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132359" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132360" style="color: #000000">            </span><span __designer:dtid="844424930132361" style="color: blue">commit</span><span __designer:dtid="844424930132362" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132364" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132365" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132366" style="color: #000000">      </span><span __designer:dtid="844424930132367" style="color: blue">end</span><span __designer:dtid="844424930132368" style="color: #000000"> </span><span __designer:dtid="844424930132369" style="color: blue">try</span></span></p> <p __designer:dtid="844424930132371" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132372" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132373" style="color: #000000">      </span><span __designer:dtid="844424930132374" style="color: blue">begin</span><span __designer:dtid="844424930132375" style="color: #000000"> </span><span __designer:dtid="844424930132376" style="color: blue">catch</span></span></p> <p __designer:dtid="844424930132378" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132379" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132380" style="color: #000000">            </span><span __designer:dtid="844424930132381" style="color: blue">declare</span><span __designer:dtid="844424930132382" style="color: #000000"> @error </span><span __designer:dtid="844424930132383" style="color: blue">int</span><span __designer:dtid="844424930132384" style="color: gray">,</span><span __designer:dtid="844424930132385" style="color: #000000"> @message </span><span __designer:dtid="844424930132386" style="color: blue">nvarchar</span><span __designer:dtid="844424930132387" style="color: gray">(</span><span __designer:dtid="844424930132388" style="color: #000000">4000</span><span __designer:dtid="844424930132389" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132391" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132392" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132393" style="color: #000000">            </span><span __designer:dtid="844424930132394" style="color: blue">select</span><span __designer:dtid="844424930132395" style="color: #000000"> @error </span><span __designer:dtid="844424930132396" style="color: gray">=</span><span __designer:dtid="844424930132397" style="color: #000000"> </span><span _\_designer:dtid="844424930132398" style="color: fuchsia">ERROR\_NUMBER</span><span __designer:dtid="844424930132399" style="color: gray">(),</span><span __designer:dtid="844424930132400" style="color: #000000"> @message </span><span __designer:dtid="844424930132401" style="color: gray">=</span><span __designer:dtid="844424930132402" style="color: #000000"> </span><span _\_designer:dtid="844424930132403" style="color: fuchsia">ERROR\_MESSAGE</span><span __designer:dtid="844424930132404" style="color: gray">();</span></span></p> <p __designer:dtid="844424930132406" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132407" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132408" style="color: #000000">            </span><span __designer:dtid="844424930132409" style="color: blue">end</span><span __designer:dtid="844424930132410" style="color: #000000"> </span><span __designer:dtid="844424930132411" style="color: blue">conversation</span><span __designer:dtid="844424930132412" style="color: #000000"> @handle </span><span __designer:dtid="844424930132413" style="color: blue">with</span><span __designer:dtid="844424930132414" style="color: #000000"> error </span><span __designer:dtid="844424930132415" style="color: gray">=</span><span __designer:dtid="844424930132416" style="color: #000000"> @error </span><span __designer:dtid="844424930132417" style="color: blue">description</span><span __designer:dtid="844424930132418" style="color: #000000"> </span><span __designer:dtid="844424930132419" style="color: gray">=</span><span __designer:dtid="844424930132420" style="color: #000000"> @message</span><span __designer:dtid="844424930132421" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132423" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132424" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132425" style="color: #000000">            </span><span __designer:dtid="844424930132426" style="color: blue">commit</span><span __designer:dtid="844424930132427" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132429" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132430" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132431" style="color: #000000">      </span><span __designer:dtid="844424930132432" style="color: blue">end</span><span __designer:dtid="844424930132433" style="color: #000000"> </span><span __designer:dtid="844424930132434" style="color: blue">catch</span><span __designer:dtid="844424930132435" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132437" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132438" style="font-size: 10pt; color: blue; font-family: 'Courier New'">end</span></p> <p __designer:dtid="844424930132440" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132441" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132442" style="color: #000000">go</span></span></p> <p __designer:dtid="844424930132444" style="margin: 0in 0in 0pt" class="MsoNormal">&nbsp;</p> 

<span __designer:dtid="844424930132445" style="font-size: 10pt; font-family: 'Courier New'">        </span>

</span><p __designer:dtid="844424930132447" style="margin: 0in 0in 0pt" class="MsoNormal"><span _\_designer:dtid="844424930132448" style="font-size: 10pt; color: green; font-family: 'Courier New'">&#8212; attach the procedure to the target\_queue as an activated procedure</span></p> <p __designer:dtid="844424930132450" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132451" style="font-size: 10pt; color: blue; font-family: 'Courier New'">alter</span><span __designer:dtid="844424930132452" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132453" style="color: blue">queue</span> [target_queue]</span></p> <p __designer:dtid="844424930132455" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132456" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132457">      </span><span __designer:dtid="844424930132458" style="color: blue">with</span> activation <span __designer:dtid="844424930132459" style="color: gray">(</span></span></p> <p __designer:dtid="844424930132461" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132462" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132463">            </span><span __designer:dtid="844424930132464" style="color: blue">status</span> <span __designer:dtid="844424930132465" style="color: gray">=</span> <span __designer:dtid="844424930132466" style="color: blue">on</span><span __designer:dtid="844424930132467" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132469" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132470" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132471">            </span>max\_queue\_readers <span __designer:dtid="844424930132472" style="color: gray">=</span> 1<span __designer:dtid="844424930132473" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132475" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132476" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132477">            </span>procedure_name <span __designer:dtid="844424930132478" style="color: gray">=</span> [usp_target]<span __designer:dtid="844424930132479" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132481" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132482" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132483">            </span><span __designer:dtid="844424930132484" style="color: blue">execute</span> <span __designer:dtid="844424930132485" style="color: blue">as</span> <span __designer:dtid="844424930132486" style="color: blue">owner</span><span __designer:dtid="844424930132487" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132489" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132490" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930132492">&nbsp;</p> <p __designer:dtid="844424930132493">As you can see, the error handling in the stored procedure is handled by a BEGIN TRY/BEGIN CATCH block, and the error handling consist of ending the conversation with an error, sending back the error number and message to the original sender. Of course, in a real application it would probably make sense to clearly define error numbers and messages reported by the target service, as is not really useful to send back to the sender some internal database engine codes and messages. So now lets go ahead and test our service:</p> <p __designer:dtid="844424930132494" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132495" style="font-size: 10pt; color: green; font-family: 'Courier New'">&#8212; send a message to the target service</span></p> <p __designer:dtid="844424930132497" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132498" style="font-size: 10pt; color: blue; font-family: 'Courier New'">declare</span><span __designer:dtid="844424930132499" style="font-size: 10pt; font-family: 'Courier New'"> @handle <span __designer:dtid="844424930132500" style="color: blue">uniqueidentifier</span><span __designer:dtid="844424930132501" style="color: gray">,</span> @payload <span __designer:dtid="844424930132502" style="color: blue">xml</span><span __designer:dtid="844424930132503" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132505" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132506" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span><span __designer:dtid="844424930132507" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132508" style="color: blue">transaction</span><span __designer:dtid="844424930132509" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132511" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132512" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span><span __designer:dtid="844424930132513" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132514" style="color: blue">dialog</span> <span __designer:dtid="844424930132515" style="color: blue">conversation</span> @handle</span></p> <p __designer:dtid="844424930132517" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132518" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132519">      </span><span __designer:dtid="844424930132520" style="color: blue">from</span> <span __designer:dtid="844424930132521" style="color: blue">service</span> [sender_service]</span></p> <p __designer:dtid="844424930132523" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132524" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132525">      </span><span __designer:dtid="844424930132526" style="color: blue">to</span> <span __designer:dtid="844424930132527" style="color: blue">service</span> <span _\_designer:dtid="844424930132528" style="color: red">&#8216;target\_service&#8217;</span><span __designer:dtid="844424930132529" style="color: gray">,</span> <span __designer:dtid="844424930132530" style="color: red">&#8216;current database&#8217;</span></span></p> <p __designer:dtid="844424930132532" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132533" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132534">      </span><span __designer:dtid="844424930132535" style="color: blue">with</span> <span __designer:dtid="844424930132536" style="color: blue">encryption</span> <span __designer:dtid="844424930132537" style="color: gray">=</span> <span __designer:dtid="844424930132538" style="color: blue">off</span><span __designer:dtid="844424930132539" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132541" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132542" style="font-size: 10pt; color: gray; font-family: 'Courier New'">        </span></p> <p __designer:dtid="844424930132544" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132545" style="font-size: 10pt; color: blue; font-family: 'Courier New'">select</span><span __designer:dtid="844424930132546" style="font-size: 10pt; font-family: 'Courier New'"> @payload <span __designer:dtid="844424930132547" style="color: gray">=</span> N<span __designer:dtid="844424930132548" style="color: red">&#8216;<payload><entry id=&#8221;1&#8243; key=&#8221;A&#8221; value=&#8221;B&#8221;/></payload>&#8217;</span><span __designer:dtid="844424930132549" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132551" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132552" style="font-size: 10pt; color: blue; font-family: 'Courier New'">send</span><span __designer:dtid="844424930132553" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132554" style="color: blue">on</span> <span __designer:dtid="844424930132555" style="color: blue">conversation</span> @handle <span __designer:dtid="844424930132556" style="color: gray">(</span>@payload<span __designer:dtid="844424930132557" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132559" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132560" style="font-size: 10pt; color: blue; font-family: 'Courier New'">commit</span><span __designer:dtid="844424930132561" style="font-size: 10pt; color: gray; font-family: 'Courier New'">;</span></p> <p __designer:dtid="844424930132563" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132564" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930132566">&nbsp;</p> <p _\_designer:dtid="844424930132567">If we look into the target\_table we find the entry we sent (1, A, B). The response that came back from the target service is sitting in the sender_queue and is a mundane EndDialog message, indicating the succesfull completion of the &#8216;assignment&#8217;.</p> <p _\_designer:dtid="844424930132568">Now if we simply run the very same SEND example, we&#8217;re gonna trigger an error, because the same values would violate the primary key constraint on the target\_table. So go ahead and run this again:</p> <p __designer:dtid="844424930132569" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132570" style="font-size: 10pt; color: green; font-family: 'Courier New'">&#8212; send a message to the target service</span></p> <p __designer:dtid="844424930132572" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132573" style="font-size: 10pt; color: blue; font-family: 'Courier New'">declare</span><span __designer:dtid="844424930132574" style="font-size: 10pt; font-family: 'Courier New'"> @handle <span __designer:dtid="844424930132575" style="color: blue">uniqueidentifier</span><span __designer:dtid="844424930132576" style="color: gray">,</span> @payload <span __designer:dtid="844424930132577" style="color: blue">xml</span><span __designer:dtid="844424930132578" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132580" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132581" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span><span __designer:dtid="844424930132582" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132583" style="color: blue">transaction</span><span __designer:dtid="844424930132584" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132586" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132587" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span><span __designer:dtid="844424930132588" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132589" style="color: blue">dialog</span> <span __designer:dtid="844424930132590" style="color: blue">conversation</span> @handle</span></p> <p __designer:dtid="844424930132592" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132593" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132594">      </span><span __designer:dtid="844424930132595" style="color: blue">from</span> <span __designer:dtid="844424930132596" style="color: blue">service</span> [sender_service]</span></p> <p __designer:dtid="844424930132598" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132599" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132600">      </span><span __designer:dtid="844424930132601" style="color: blue">to</span> <span __designer:dtid="844424930132602" style="color: blue">service</span> <span _\_designer:dtid="844424930132603" style="color: red">&#8216;target\_service&#8217;</span><span __designer:dtid="844424930132604" style="color: gray">,</span> <span __designer:dtid="844424930132605" style="color: red">&#8216;current database&#8217;</span></span></p> <p __designer:dtid="844424930132607" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132608" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132609">      </span><span __designer:dtid="844424930132610" style="color: blue">with</span> <span __designer:dtid="844424930132611" style="color: blue">encryption</span> <span __designer:dtid="844424930132612" style="color: gray">=</span> <span __designer:dtid="844424930132613" style="color: blue">off</span><span __designer:dtid="844424930132614" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132616" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132617" style="font-size: 10pt; color: gray; font-family: 'Courier New'">        </span></p> <p __designer:dtid="844424930132619" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132620" style="font-size: 10pt; color: blue; font-family: 'Courier New'">select</span><span __designer:dtid="844424930132621" style="font-size: 10pt; font-family: 'Courier New'"> @payload <span __designer:dtid="844424930132622" style="color: gray">=</span> N<span __designer:dtid="844424930132623" style="color: red">&#8216;<payload><entry id=&#8221;1&#8243; key=&#8221;A&#8221; value=&#8221;B&#8221;/></payload>&#8217;</span><span __designer:dtid="844424930132624" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132626" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132627" style="font-size: 10pt; color: blue; font-family: 'Courier New'">send</span><span __designer:dtid="844424930132628" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132629" style="color: blue">on</span> <span __designer:dtid="844424930132630" style="color: blue">conversation</span> @handle <span __designer:dtid="844424930132631" style="color: gray">(</span>@payload<span __designer:dtid="844424930132632" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132634" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132635" style="font-size: 10pt; color: blue; font-family: 'Courier New'">commit</span><span __designer:dtid="844424930132636" style="font-size: 10pt; color: gray; font-family: 'Courier New'">;</span></p> <p __designer:dtid="844424930132638" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132639" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930132641">&nbsp;</p> <p _\_designer:dtid="844424930132642">Now the sender\_queue has received an error message:</p> <p __designer:dtid="844424930132643" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132644" style="font-size: 10pt; color: gray; font-family: 'Courier New'"><</span><span __designer:dtid="844424930132645" style="font-size: 10pt; font-family: 'Courier New'">Error xmlns<span __designer:dtid="844424930132646" style="color: gray">=</span>&#8220;http://schemas.microsoft.com/SQL/ServiceBroker/Error&#8221;<span __designer:dtid="844424930132647" style="color: gray">></span></span></p> <p __designer:dtid="844424930132649" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132650" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132651">  </span><span __designer:dtid="844424930132652" style="color: gray"><</span>Code<span __designer:dtid="844424930132653" style="color: gray">></span>2627<span __designer:dtid="844424930132654" style="color: gray"></</span>Code<span __designer:dtid="844424930132655" style="color: gray">></span></span></p> <p __designer:dtid="844424930132657" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132658" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132659">  </span><span __designer:dtid="844424930132660" style="color: gray"><</span><span __designer:dtid="844424930132661" style="color: blue">Description</span><span __designer:dtid="844424930132662" style="color: gray">></span>Violation <span __designer:dtid="844424930132663" style="color: blue">of</span> <span __designer:dtid="844424930132664" style="color: blue">PRIMARY</span> <span __designer:dtid="844424930132665" style="color: blue">KEY</span> <span __designer:dtid="844424930132666" style="color: blue">constraint</span> <span \_\_designer:dtid="844424930132667" style="color: red">&#8216;PK\_\_target\_table\__0AD2A005&#8217;</span><span __designer:dtid="844424930132668" style="color: gray">.</span> Cannot <span __designer:dtid="844424930132669" style="color: blue">insert</span> duplicate <span __designer:dtid="844424930132670" style="color: blue">key</span> <span __designer:dtid="844424930132671" style="color: gray">in</span> <span __designer:dtid="844424930132672" style="color: blue">object</span> <span _\_designer:dtid="844424930132673" style="color: red">&#8216;dbo.target\_table&#8217;</span><span __designer:dtid="844424930132674" style="color: gray">.</</span><span __designer:dtid="844424930132675" style="color: blue">Description</span><span __designer:dtid="844424930132676" style="color: gray">></span></span></p> <p __designer:dtid="844424930132678" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132679" style="font-size: 10pt; color: gray; font-family: 'Courier New'"></</span><span __designer:dtid="844424930132680" style="font-size: 10pt; font-family: 'Courier New'">Error<span __designer:dtid="844424930132681" style="color: gray">></span></span></p> <p __designer:dtid="844424930132683">So our error handling works as we expected and the service is handling error conditions fine. So is this the end of the story?</p> <h2 __designer:dtid="844424930132684">Doomed Transactions</h2> <p __designer:dtid="844424930132685">&nbsp;</p> <p __designer:dtid="844424930132686">As it turns out, we&#8217;ve only skimmed the surface and we&#8217;re about to open one nasty can of worms. To proove this lets produce the one most common mistake that happens during development: a malformed payload:</p> <p __designer:dtid="844424930132687" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132688" style="font-size: 10pt; color: green; font-family: 'Courier New'">&#8212; send a message to the target service</span></p> <p __designer:dtid="844424930132690" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132691" style="font-size: 10pt; color: blue; font-family: 'Courier New'">declare</span><span __designer:dtid="844424930132692" style="font-size: 10pt; font-family: 'Courier New'"> @handle <span __designer:dtid="844424930132693" style="color: blue">uniqueidentifier</span><span __designer:dtid="844424930132694" style="color: gray">,</span> @payload <span __designer:dtid="844424930132695" style="color: blue">nvarchar</span><span __designer:dtid="844424930132696" style="color: gray">(</span><span __designer:dtid="844424930132697" style="color: fuchsia">max</span><span __designer:dtid="844424930132698" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132700" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132701" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span><span __designer:dtid="844424930132702" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132703" style="color: blue">transaction</span><span __designer:dtid="844424930132704" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132706" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132707" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span><span __designer:dtid="844424930132708" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132709" style="color: blue">dialog</span> <span __designer:dtid="844424930132710" style="color: blue">conversation</span> @handle</span></p> <p __designer:dtid="844424930132712" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132713" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132714">      </span><span __designer:dtid="844424930132715" style="color: blue">from</span> <span __designer:dtid="844424930132716" style="color: blue">service</span> [sender_service]</span></p> <p __designer:dtid="844424930132718" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132719" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132720">      </span><span __designer:dtid="844424930132721" style="color: blue">to</span> <span __designer:dtid="844424930132722" style="color: blue">service</span> <span _\_designer:dtid="844424930132723" style="color: red">&#8216;target\_service&#8217;</span><span __designer:dtid="844424930132724" style="color: gray">,</span> <span __designer:dtid="844424930132725" style="color: red">&#8216;current database&#8217;</span></span></p> <p __designer:dtid="844424930132727" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132728" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132729">      </span><span __designer:dtid="844424930132730" style="color: blue">with</span> <span __designer:dtid="844424930132731" style="color: blue">encryption</span> <span __designer:dtid="844424930132732" style="color: gray">=</span> <span __designer:dtid="844424930132733" style="color: blue">off</span><span __designer:dtid="844424930132734" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132736" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132737" style="font-size: 10pt; color: gray; font-family: 'Courier New'">        </span></p> <p __designer:dtid="844424930132739" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132740" style="font-size: 10pt; color: blue; font-family: 'Courier New'">select</span><span __designer:dtid="844424930132741" style="font-size: 10pt; font-family: 'Courier New'"> @payload <span __designer:dtid="844424930132742" style="color: gray">=</span> N<span __designer:dtid="844424930132743" style="color: red">&#8216;<payload><entry id=&#8221;1&#8243; key=&#8221;A&#8221; value=&#8221;B&#8221;></payload>&#8217;</span><span __designer:dtid="844424930132744" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132746" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132747" style="font-size: 10pt; color: blue; font-family: 'Courier New'">send</span><span __designer:dtid="844424930132748" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132749" style="color: blue">on</span> <span __designer:dtid="844424930132750" style="color: blue">conversation</span> @handle <span __designer:dtid="844424930132751" style="color: gray">(</span>@payload<span __designer:dtid="844424930132752" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132754" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132755" style="font-size: 10pt; color: blue; font-family: 'Courier New'">commit</span><span __designer:dtid="844424930132756" style="font-size: 10pt; color: gray; font-family: 'Courier New'">;</span></p> <p __designer:dtid="844424930132758" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132759" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p _\_designer:dtid="844424930132760">The payload in this case is incorrect, the <entry> tag is not closed. So what happens with our message? Nothing apparently, the message simply stays in the target\_queue and refuses to be processed, as a simple check using  <span __designer:dtid="844424930132761" style="font-size: 10pt; color: blue; font-family: 'Courier New'">select</span><span __designer:dtid="844424930132762" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132763" style="color: gray">*</span> <span __designer:dtid="844424930132764" style="color: blue">from</span> [target_queue] </span>shows! The obvious culprit should be that message failed to be processed 5 times and the poison message detection has intervened and deactivated the target_queue so lets go ahead and check it:</p> <p __designer:dtid="844424930132765" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132766" style="font-size: 10pt; color: blue; font-family: 'Courier New'">select</span><span __designer:dtid="844424930132767" style="font-size: 10pt; font-family: 'Courier New'"> [name]<span __designer:dtid="844424930132768" style="color: gray">,</span> is\_receive\_enabled <span __designer:dtid="844424930132769" style="color: blue">from</span> <span _\_designer:dtid="844424930132770" style="color: green">sys.service\_queues</span></span></p> <p __designer:dtid="844424930132771">Now I reckon that as I was writing this piece, I had a big surprise to see that the queue is &#8230; not disabled! In fact I had to delete a paragraph I had already wrote,  and come back and revisit this behavior. So what happened? It turns out that the activation mechanism was actualy fooled by our erroneous message to put the queue in the NOTIFIED state, and leave it as such, as a check on the <a __designer:dtid="844424930132772" href="http://msdn2.microsoft.com/en-us/library/ms177628.aspx">relevant DMV</a> shows: <span __designer:dtid="844424930132773" style="font-size: 10pt; color: blue; font-family: 'Courier New'">select</span><span __designer:dtid="844424930132774" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132775" style="color: gray">*</span> <span __designer:dtid="844424930132776" style="color: blue">from</span> <span _\_designer:dtid="844424930132777" style="color: green">sys.dm\_broker\_queue\_monitors. </span></span>The NOTIFIED state occurs when an activated procedure was launched but the RECEIVE verb has not been run on the activated queue. But our activated procedure was not running, as a quick check on <span __designer:dtid="844424930132778" style="font-size: 10pt; color: blue; font-family: 'Courier New'">select</span><span __designer:dtid="844424930132779" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132780" style="color: gray">*</span> <span __designer:dtid="844424930132781" style="color: blue">from</span> <span _\_designer:dtid="844424930132782" style="color: green">sys.dm\_broker\_activated\_tasks </span></span>shows. A second check on the ERRORLOG (or the system event viewer) revealed the problem:</p> <blockquote __designer:dtid="844424930132783">

<tt _\_designer:dtid="844424930132784">2007-10-31 16:31:52.57 spid52s The activated proc [dbo].[usp\_target] running on queue tempdb.dbo.target_queue output the following: 'The current transaction cannot be committed and cannot support operations that write to the log file. Roll back the transaction.'</tt><tt __designer:dtid="844424930132785"> </tt></blockquote> <p __designer:dtid="844424930132786">So our procedure wad run, had hit an exception, but our exception handler was not capable of dealing with the problem. The error in the ERRORLOG indicates that we are dealing with an uncommittable transaction issue. So apparently we need to augment our error handling CATCH block to deal with such problems, and the <a _\_designer:dtid="844424930132787" href="http://msdn2.microsoft.com/en-us/library/ms189797.aspx">XACT\_STATE</a> documentation shows how this can be achieved. So we&#8217;re gonna modify our CATCH block to deal with doomed transactions and we&#8217;re also gonna modify our RECEIVE code slightly not to cast to XML during the RECEIVE statement, since that apparently is fooling the activation machinery which behaves as if the RECEIVE never occured. Here is our modified procedure:</p> <p __designer:dtid="844424930132788" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132789" style="font-size: 10pt; color: green; font-family: 'Courier New'">&#8212; Our modified procedure

<!--l namespace="" ns="urn:schemas-microsoft-com:office:office"                  prefix="o"--></span></p> <p __designer:dtid="844424930132791" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132792" style="font-size: 10pt; color: blue; font-family: 'Courier New'">alter</span><span __designer:dtid="844424930132793" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930132794" style="color: blue">procedure</span> [usp_target]</span></p> <p __designer:dtid="844424930132796" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132797" style="font-size: 10pt; color: blue; font-family: 'Courier New'">as</span></p> <p __designer:dtid="844424930132799" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132800" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span></p> <p __designer:dtid="844424930132802" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132803" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132804">      </span><span __designer:dtid="844424930132805" style="color: blue">set</span> <span __designer:dtid="844424930132806" style="color: blue">nocount</span> <span __designer:dtid="844424930132807" style="color: blue">on</span><span __designer:dtid="844424930132808" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132810" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132811" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132812">      </span><span __designer:dtid="844424930132813" style="color: blue">declare</span> @handle <span __designer:dtid="844424930132814" style="color: blue">uniqueidentifier</span><span __designer:dtid="844424930132815" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132817" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132818" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132819">      </span><span __designer:dtid="844424930132820" style="color: blue">declare</span> @messageType <span __designer:dtid="844424930132821" style="color: blue">sysname</span><span __designer:dtid="844424930132822" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132824" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132825" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132826">      </span><span __designer:dtid="844424930132827" style="color: blue">declare</span> @messageBody <span __designer:dtid="844424930132828" style="color: blue">varbinary</span><span __designer:dtid="844424930132829" style="color: gray">(</span><span __designer:dtid="844424930132830" style="color: fuchsia">max</span><span __designer:dtid="844424930132831" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132833" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132834" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132835">      </span><span __designer:dtid="844424930132836" style="color: blue">declare</span> @payload <span __designer:dtid="844424930132837" style="color: blue">xml</span><span __designer:dtid="844424930132838" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132840" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132841" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132842">      </span></span></p> <p __designer:dtid="844424930132844" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132845" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132846">      </span><span __designer:dtid="844424930132847" style="color: blue">begin</span> <span __designer:dtid="844424930132848" style="color: blue">try</span></span></p> <p __designer:dtid="844424930132850" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132851" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132852">            </span><span __designer:dtid="844424930132853" style="color: blue">begin</span> <span __designer:dtid="844424930132854" style="color: blue">transaction</span><span __designer:dtid="844424930132855" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132857" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132858" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132859">            </span><span __designer:dtid="844424930132860" style="color: blue">waitfor</span> <span __designer:dtid="844424930132861" style="color: gray">(</span><span __designer:dtid="844424930132862" style="color: blue">receive</span> <span __designer:dtid="844424930132863" style="color: blue">top</span> <span __designer:dtid="844424930132864" style="color: gray">(</span>1<span __designer:dtid="844424930132865" style="color: gray">)</span></span></p> <p __designer:dtid="844424930132867" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132868" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132869">                  </span>@handle <span __designer:dtid="844424930132870" style="color: gray">=</span> <span _\_designer:dtid="844424930132871" style="color: blue">conversation\_handle</span><span __designer:dtid="844424930132872" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132874" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132875" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132876">                  </span>@messageType <span __designer:dtid="844424930132877" style="color: gray">=</span> message\_type\_name<span __designer:dtid="844424930132878" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132880" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132881" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132882">                  </span>@messageBody <span __designer:dtid="844424930132883" style="color: gray">=</span> message_body</span></p> <p __designer:dtid="844424930132885" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132886" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132887">                  </span><span __designer:dtid="844424930132888" style="color: blue">from</span> [target_queue]<span __designer:dtid="844424930132889" style="color: gray">),</span> <span __designer:dtid="844424930132890" style="color: blue">timeout</span> 1000<span __designer:dtid="844424930132891" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132893" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132894" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132895">            </span><span __designer:dtid="844424930132896" style="color: blue">if</span> <span __designer:dtid="844424930132897" style="color: gray">(</span>0 <span __designer:dtid="844424930132898" style="color: gray">!=</span> <span __designer:dtid="844424930132899" style="color: fuchsia">@@rowcount</span><span __designer:dtid="844424930132900" style="color: gray">)</span></span></p> <p __designer:dtid="844424930132902" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132903" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132904">            </span><span __designer:dtid="844424930132905" style="color: blue">begin</span></span></p> <p __designer:dtid="844424930132907" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132908" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132909">                  </span><span __designer:dtid="844424930132910" style="color: blue">if</span> <span __designer:dtid="844424930132911" style="color: gray">(</span>@messageType <span __designer:dtid="844424930132912" style="color: gray">=</span> <span __designer:dtid="844424930132913" style="color: red">&#8216;DEFAULT&#8217;</span><span __designer:dtid="844424930132914" style="color: gray">)</span></span></p> <p __designer:dtid="844424930132916" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132917" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132918">                  </span><span __designer:dtid="844424930132919" style="color: blue">begin</span></span></p> <p __designer:dtid="844424930132921" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132922" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132923">                        </span><span __designer:dtid="844424930132924" style="color: blue">select</span> @payload <span __designer:dtid="844424930132925" style="color: gray">=</span> <span __designer:dtid="844424930132926" style="color: fuchsia">cast</span><span __designer:dtid="844424930132927" style="color: gray">(</span>@messageBody <span __designer:dtid="844424930132928" style="color: blue">as</span> <span __designer:dtid="844424930132929" style="color: blue">xml</span><span __designer:dtid="844424930132930" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132932" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132933" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132934">                        </span><span __designer:dtid="844424930132935" style="color: blue">insert</span> <span __designer:dtid="844424930132936" style="color: blue">into</span> [target_table] <span __designer:dtid="844424930132937" style="color: gray">(</span></span></p> <p __designer:dtid="844424930132939" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132940" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132941">                              </span>[id]<span __designer:dtid="844424930132942" style="color: gray">,</span> [key]<span __designer:dtid="844424930132943" style="color: gray">,</span> [value]<span __designer:dtid="844424930132944" style="color: gray">)</span> </span></p> <p __designer:dtid="844424930132946" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132947" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132948">                              </span><span __designer:dtid="844424930132949" style="color: blue">select</span> e<span __designer:dtid="844424930132950" style="color: gray">.</span>value<span __designer:dtid="844424930132951" style="color: gray">(</span><span __designer:dtid="844424930132952" style="color: red">&#8216;@id&#8217;</span><span __designer:dtid="844424930132953" style="color: gray">,</span> <span __designer:dtid="844424930132954" style="color: red">&#8216;int&#8217;</span><span __designer:dtid="844424930132955" style="color: gray">)</span> <span __designer:dtid="844424930132956" style="color: blue">as</span> [id]<span __designer:dtid="844424930132957" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132959" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132960" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132961">                                    </span>e<span __designer:dtid="844424930132962" style="color: gray">.</span>value<span __designer:dtid="844424930132963" style="color: gray">(</span><span __designer:dtid="844424930132964" style="color: red">&#8216;@key&#8217;</span><span __designer:dtid="844424930132965" style="color: gray">,</span> <span __designer:dtid="844424930132966" style="color: red">&#8216;nvarchar(256)&#8217;</span><span __designer:dtid="844424930132967" style="color: gray">)</span> <span __designer:dtid="844424930132968" style="color: blue">as</span> [key]<span __designer:dtid="844424930132969" style="color: gray">,</span></span></p> <p __designer:dtid="844424930132971" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132972" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132973">                                    </span>e<span __designer:dtid="844424930132974" style="color: gray">.</span>value<span __designer:dtid="844424930132975" style="color: gray">(</span><span __designer:dtid="844424930132976" style="color: red">&#8216;@value&#8217;</span><span __designer:dtid="844424930132977" style="color: gray">,</span> <span __designer:dtid="844424930132978" style="color: red">&#8216;nvarchar(256)&#8217;</span><span __designer:dtid="844424930132979" style="color: gray">)</span> <span __designer:dtid="844424930132980" style="color: blue">as</span> [value]</span></p> <p __designer:dtid="844424930132982" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132983" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132984">                                    </span><span __designer:dtid="844424930132985" style="color: blue">from</span> @payload<span __designer:dtid="844424930132986" style="color: gray">.</span>nodes<span __designer:dtid="844424930132987" style="color: gray">(</span><span __designer:dtid="844424930132988" style="color: red">&#8216;//payload/entry&#8217;</span><span __designer:dtid="844424930132989" style="color: gray">)</span> p<span __designer:dtid="844424930132990" style="color: gray">(</span>e<span __designer:dtid="844424930132991" style="color: gray">);</span></span></p> <p __designer:dtid="844424930132993" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930132994" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930132995">                  </span><span __designer:dtid="844424930132996" style="color: blue">end</span><span __designer:dtid="844424930132997" style="color: gray">;</span></span></p> <p __designer:dtid="844424930132999" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133000" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133001">                  </span><span __designer:dtid="844424930133002" style="color: blue">end</span> <span __designer:dtid="844424930133003" style="color: blue">conversation</span> @handle<span __designer:dtid="844424930133004" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133006" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133007" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133008">            </span><span __designer:dtid="844424930133009" style="color: blue">end</span> </span></p> <p __designer:dtid="844424930133011" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133012" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133013">            </span><span __designer:dtid="844424930133014" style="color: blue">commit</span><span __designer:dtid="844424930133015" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133017" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133018" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133019">      </span><span __designer:dtid="844424930133020" style="color: blue">end</span> <span __designer:dtid="844424930133021" style="color: blue">try</span></span></p> <p __designer:dtid="844424930133023" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133024" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133025">      </span><span __designer:dtid="844424930133026" style="color: blue">begin</span> <span __designer:dtid="844424930133027" style="color: blue">catch</span></span></p> <p __designer:dtid="844424930133029" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133030" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133031">            </span><span _\_designer:dtid="844424930133032" style="color: green">&#8212; Test XACT\_STATE for 0, 1, or -1.</span></span></p> <p __designer:dtid="844424930133034" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133035" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133036">            </span><span __designer:dtid="844424930133037" style="color: green">&#8212; If 1, the transaction is committable.</span></span></p> <p __designer:dtid="844424930133039" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133040" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133041">            </span><span __designer:dtid="844424930133042" style="color: green">&#8212; If -1, the transaction is uncommittable and should </span></span></p> <p __designer:dtid="844424930133044" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133045" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133046">            </span><span __designer:dtid="844424930133047" style="color: green">&#8212;<span __designer:dtid="844424930133048">     </span>be rolled back.</span></span></p> <p __designer:dtid="844424930133050" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133051" style="font-size: 10pt; color: green; font-family: 'Courier New'">  </span></p> <p __designer:dtid="844424930133053" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133054" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133055">            </span><span __designer:dtid="844424930133056" style="color: green">&#8212; Test whether the transaction is uncommittable.</span></span></p> <p __designer:dtid="844424930133058" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133059" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133060">            </span><span __designer:dtid="844424930133061" style="color: blue">if</span> <span __designer:dtid="844424930133062" style="color: gray">(</span><span _\_designer:dtid="844424930133063" style="color: fuchsia">XACT\_STATE</span><span __designer:dtid="844424930133064" style="color: gray">())</span> <span __designer:dtid="844424930133065" style="color: gray">=</span> <span __designer:dtid="844424930133066" style="color: gray">&#8211;</span>1</span></p> <p __designer:dtid="844424930133068" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133069" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133070">            </span><span __designer:dtid="844424930133071" style="color: blue">begin</span></span></p> <p __designer:dtid="844424930133073" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133074" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133075">                  </span><span __designer:dtid="844424930133076" style="color: blue">rollback</span> <span __designer:dtid="844424930133077" style="color: blue">transaction</span><span __designer:dtid="844424930133078" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133080" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133081" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133082">            </span><span __designer:dtid="844424930133083" style="color: blue">end</span><span __designer:dtid="844424930133084" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133086" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133087" style="font-size: 10pt; color: gray; font-family: 'Courier New'">  </span></p> <p __designer:dtid="844424930133089" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133090" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133091">            </span><span __designer:dtid="844424930133092" style="color: green">&#8212; Test wether the transaction is active and valid.</span></span></p> <p __designer:dtid="844424930133094" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133095" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133096">            </span><span __designer:dtid="844424930133097" style="color: blue">if</span> <span __designer:dtid="844424930133098" style="color: gray">(</span><span _\_designer:dtid="844424930133099" style="color: fuchsia">XACT\_STATE</span><span __designer:dtid="844424930133100" style="color: gray">())</span> <span __designer:dtid="844424930133101" style="color: gray">=</span> 1</span></p> <p __designer:dtid="844424930133103" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133104" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133105">            </span><span __designer:dtid="844424930133106" style="color: blue">begin</span></span></p> <p __designer:dtid="844424930133108" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133109" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133110"> </span><span __designer:dtid="844424930133111">                 </span><span __designer:dtid="844424930133112" style="color: blue">declare</span> @error <span __designer:dtid="844424930133113" style="color: blue">int</span><span __designer:dtid="844424930133114" style="color: gray">,</span> @message <span __designer:dtid="844424930133115" style="color: blue">nvarchar</span><span __designer:dtid="844424930133116" style="color: gray">(</span>4000<span __designer:dtid="844424930133117" style="color: gray">);</span></span></p> <p __designer:dtid="844424930133119" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133120" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133121">                  </span><span __designer:dtid="844424930133122" style="color: blue">select</span> @error <span __designer:dtid="844424930133123" style="color: gray">=</span> <span _\_designer:dtid="844424930133124" style="color: fuchsia">ERROR\_NUMBER</span><span __designer:dtid="844424930133125" style="color: gray">(),</span> @message <span __designer:dtid="844424930133126" style="color: gray">=</span> <span _\_designer:dtid="844424930133127" style="color: fuchsia">ERROR\_MESSAGE</span><span __designer:dtid="844424930133128" style="color: gray">();</span></span></p> <p __designer:dtid="844424930133130" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133131" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133132">                  </span><span __designer:dtid="844424930133133" style="color: blue">end</span> <span __designer:dtid="844424930133134" style="color: blue">conversation</span> @handle <span __designer:dtid="844424930133135" style="color: blue">with</span> error <span __designer:dtid="844424930133136" style="color: gray">=</span> @error <span __designer:dtid="844424930133137" style="color: blue">description</span> <span __designer:dtid="844424930133138" style="color: gray">=</span> @message<span __designer:dtid="844424930133139" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133141" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133142" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133143">                  </span><span __designer:dtid="844424930133144" style="color: blue">commit</span><span __designer:dtid="844424930133145" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133147" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133148" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133149">            </span><span __designer:dtid="844424930133150" style="color: blue">end</span></span></p> <p __designer:dtid="844424930133152" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133153" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133154">            </span><span __designer:dtid="844424930133155" style="color: blue">end</span> <span __designer:dtid="844424930133156" style="color: blue">catch</span><span __designer:dtid="844424930133157" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133159" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133160" style="font-size: 10pt; color: blue; font-family: 'Courier New'">end</span></p> <p __designer:dtid="844424930133162" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133163" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p _\_designer:dtid="844424930133164">We alter the proceure, turn activation back on and&#8230; yet again nothig, the message is still sitting in the target\_queue. This time though the queue was correctly disabled, we check the <span __designer:dtid="844424930133165" style="font-size: 10pt; color: blue; font-family: 'Courier New'">select</span><span __designer:dtid="844424930133166" style="font-size: 10pt; font-family: 'Courier New'"> [name]<span __designer:dtid="844424930133167" style="color: gray">,</span> is\_receive\_enabled <span __designer:dtid="844424930133168" style="color: blue">from</span> <span _\_designer:dtid="844424930133169" style="color: green">sys.service\_queues </span></span>view and sure enough the queue is disabled. But wait a minute! I&#8217;m sure TRY/CATCH has its place, but this is not quite what we wanted to achieve, a simple common XML formatting error is taking down our service! How come?</p> <h2 __designer:dtid="844424930133170">Error severities</h2> <p __designer:dtid="844424930133171">As it turns out, XML casting and validation errors are raised with severity 16, and this severity will always put the transaction into an uncommittable state. For Service Broker, this is quite bad, as parsing and shreding XML is a day to day operation for most service applications. Unfortunately, there&#8217;s simply no workaround for this issue, which has the implication that one cannot use the SQL Server built-in XML methods to <em __designer:dtid="844424930133172">validate</em> the received XML programmatically, one has to ensure that the XML is valid upfront. For XML payloads fortunately there is a solution: declare the message validation on the message type and even enforce an XML schema. This will cause validation to occur prior to the message being enqueued and will ensure that the activate dprocedure has to deal only with valid input. In our case, this means to change the contract of the service to use an XML well formatted validation message:</p> <p __designer:dtid="844424930133173" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133174" style="font-size: 10pt; color: blue; font-family: 'Courier New'">create</span><span __designer:dtid="844424930133175" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930133176" style="color: blue">message</span> <span __designer:dtid="844424930133177" style="color: blue">type</span> [valid_payload] validation <span __designer:dtid="844424930133178" style="color: gray">=</span> <span _\_designer:dtid="844424930133179" style="color: blue">well\_formed_xml</span><span __designer:dtid="844424930133180" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133182" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133183" style="font-size: 10pt; color: blue; font-family: 'Courier New'">create</span><span __designer:dtid="844424930133184" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930133185" style="color: blue">contract</span> [validated_contract] <span __designer:dtid="844424930133186" style="color: gray">(</span>[valid_payload] sent <span __designer:dtid="844424930133187" style="color: blue">by</span> initiator<span __designer:dtid="844424930133188" style="color: gray">);</span></span></p> <p __designer:dtid="844424930133190" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133191" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930133193" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133194" style="font-size: 10pt; font-family: 'Courier New'">  </span></p> <p __designer:dtid="844424930133196" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133197" style="font-size: 10pt; color: blue; font-family: 'Courier New'">alter</span><span __designer:dtid="844424930133198" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930133199" style="color: blue">service</span> [target_service] <span __designer:dtid="844424930133200" style="color: gray">(</span><span __designer:dtid="844424930133201" style="color: blue">add</span> <span __designer:dtid="844424930133202" style="color: blue">contract</span> [validated_contract]<span __designer:dtid="844424930133203" style="color: gray">);</span></span></p> <p __designer:dtid="844424930133204">&nbsp;</p> <p _\_designer:dtid="844424930133205">We also need to change our activated procedure to deal with the new message type name, the &#8216;valid\_payload&#8217; type:</p> <p __designer:dtid="844424930133206">&#8230;</p> <p __designer:dtid="844424930133207" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133208" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133209">            </span><span __designer:dtid="844424930133210" style="color: blue">if</span> <span __designer:dtid="844424930133211" style="color: gray">(</span>0 <span __designer:dtid="844424930133212" style="color: gray">!=</span> <span __designer:dtid="844424930133213" style="color: fuchsia">@@rowcount</span><span __designer:dtid="844424930133214" style="color: gray">)</span></span></p> <p __designer:dtid="844424930133216" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133217" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133218">            </span><span __designer:dtid="844424930133219" style="color: blue">begin</span></span></p> <p __designer:dtid="844424930133221" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133222" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133223">                  </span><span __designer:dtid="844424930133224" style="color: blue">if</span> <span __designer:dtid="844424930133225" style="color: gray">(</span>@messageType <span __designer:dtid="844424930133226" style="color: gray">=</span> N<span _\_designer:dtid="844424930133227" style="color: red">&#8216;valid\_payload&#8217;</span><span __designer:dtid="844424930133228" style="color: gray">)</span></span></p> <p __designer:dtid="844424930133230" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133231" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133232">                  </span><span __designer:dtid="844424930133233" style="color: blue">begin</span></span></p> <p __designer:dtid="844424930133235" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133236" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133237">                        </span><span __designer:dtid="844424930133238" style="color: blue">select</span> @payload <span __designer:dtid="844424930133239" style="color: gray">=</span> <span __designer:dtid="844424930133240" style="color: fuchsia">cast</span><span __designer:dtid="844424930133241" style="color: gray">(</span>@messageBody <span __designer:dtid="844424930133242" style="color: blue">as</span> <span __designer:dtid="844424930133243" style="color: blue">xml</span><span __designer:dtid="844424930133244" style="color: gray">);</span></span></p> <p __designer:dtid="844424930133246" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133247" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133248">                        </span><span __designer:dtid="844424930133249" style="color: blue">insert</span> <span __designer:dtid="844424930133250" style="color: blue">into</span> [target_table] <span __designer:dtid="844424930133251" style="color: gray">(</span></span></p> <p __designer:dtid="844424930133253" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133254" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133255">                              </span>[id]<span __designer:dtid="844424930133256" style="color: gray">,</span> [key]<span __designer:dtid="844424930133257" style="color: gray">,</span> [value]<span __designer:dtid="844424930133258" style="color: gray">)</span> </span></p> <p __designer:dtid="844424930133260" style="margin: 0in 0in 0pt" class="MsoNormal">&#8230;</p> <p _\_designer:dtid="844424930133261">We can now reset the broker in tempdb (to get rif of the erroneous message that would prevent the target\_queue from ever becomming enabled) and enable back the target_queue:</p> <p __designer:dtid="844424930133262" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133263" style="font-size: 10pt; color: blue; font-family: 'Courier New'">alter</span><span __designer:dtid="844424930133264" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930133265" style="color: blue">database</span> tempdb <span __designer:dtid="844424930133266" style="color: blue">set</span> <span _\_designer:dtid="844424930133267" style="color: blue">new\_broker</span> <span __designer:dtid="844424930133268" style="color: blue">with</span> <span __designer:dtid="844424930133269" style="color: blue">rollback</span> immediate<span __designer:dtid="844424930133270" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133272" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133273" style="font-size: 10pt; color: gray; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930133275" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133276" style="font-size: 10pt; color: blue; font-family: 'Courier New'">alter</span><span __designer:dtid="844424930133277" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930133278" style="color: blue">queue</span> target_queue <span __designer:dtid="844424930133279" style="color: blue">with</span> <span __designer:dtid="844424930133280" style="color: blue">status</span> <span __designer:dtid="844424930133281" style="color: gray">=</span> <span __designer:dtid="844424930133282" style="color: blue">on</span><span __designer:dtid="844424930133283" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133285" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133286" style="font-size: 10pt; color: gray; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930133287">So now we can send again the erroneous message, this time using the validated contract and message type:</p> <p __designer:dtid="844424930133288" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133289" style="font-size: 10pt; color: green; font-family: 'Courier New'">&#8212; send a message to the target service</span></p> <p __designer:dtid="844424930133291" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133292" style="font-size: 10pt; color: blue; font-family: 'Courier New'">declare</span><span __designer:dtid="844424930133293" style="font-size: 10pt; font-family: 'Courier New'"> @handle <span __designer:dtid="844424930133294" style="color: blue">uniqueidentifier</span><span __designer:dtid="844424930133295" style="color: gray">,</span> @payload <span __designer:dtid="844424930133296" style="color: blue">nvarchar</span><span __designer:dtid="844424930133297" style="color: gray">(</span><span __designer:dtid="844424930133298" style="color: fuchsia">max</span><span __designer:dtid="844424930133299" style="color: gray">);</span></span></p> <p __designer:dtid="844424930133301" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133302" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span><span __designer:dtid="844424930133303" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930133304" style="color: blue">transaction</span><span __designer:dtid="844424930133305" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133307" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133308" style="font-size: 10pt; color: blue; font-family: 'Courier New'">begin</span><span __designer:dtid="844424930133309" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930133310" style="color: blue">dialog</span> <span __designer:dtid="844424930133311" style="color: blue">conversation</span> @handle</span></p> <p __designer:dtid="844424930133313" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133314" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133315">      </span><span __designer:dtid="844424930133316" style="color: blue">from</span> <span __designer:dtid="844424930133317" style="color: blue">service</span> [sender_service]</span></p> <p __designer:dtid="844424930133319" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133320" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133321">      </span><span __designer:dtid="844424930133322" style="color: blue">to</span> <span __designer:dtid="844424930133323" style="color: blue">service</span> <span _\_designer:dtid="844424930133324" style="color: red">&#8216;target\_service&#8217;</span><span __designer:dtid="844424930133325" style="color: gray">,</span> <span __designer:dtid="844424930133326" style="color: red">&#8216;current database&#8217;</span></span></p> <p __designer:dtid="844424930133328" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133329" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133330">      </span><span __designer:dtid="844424930133331" style="color: blue">on</span> <span __designer:dtid="844424930133332" style="color: blue">contract</span> [validated_contract]</span></p> <p __designer:dtid="844424930133334" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133335" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133336">      </span><span __designer:dtid="844424930133337" style="color: blue">with</span> <span __designer:dtid="844424930133338" style="color: blue">encryption</span> <span __designer:dtid="844424930133339" style="color: gray">=</span> <span __designer:dtid="844424930133340" style="color: blue">off</span><span __designer:dtid="844424930133341" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133343" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133344" style="font-size: 10pt; color: gray; font-family: 'Courier New'">  </span></p> <p __designer:dtid="844424930133346" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133347" style="font-size: 10pt; color: blue; font-family: 'Courier New'">select</span><span __designer:dtid="844424930133348" style="font-size: 10pt; font-family: 'Courier New'"> @payload <span __designer:dtid="844424930133349" style="color: gray">=</span> N<span __designer:dtid="844424930133350" style="color: red">&#8216;<payload><entry id=&#8221;1&#8243; key=&#8221;A&#8221; value=&#8221;B&#8221;></payload>&#8217;</span><span __designer:dtid="844424930133351" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133353" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133354" style="font-size: 10pt; color: blue; font-family: 'Courier New'">send</span><span __designer:dtid="844424930133355" style="font-size: 10pt; font-family: 'Courier New'"> <span __designer:dtid="844424930133356" style="color: blue">on</span> <span __designer:dtid="844424930133357" style="color: blue">conversation</span> @handle <span __designer:dtid="844424930133358" style="color: blue">message</span> <span __designer:dtid="844424930133359" style="color: blue">type</span> [valid_payload] <span __designer:dtid="844424930133360" style="color: gray">(</span>@payload<span __designer:dtid="844424930133361" style="color: gray">);</span></span></p> <p __designer:dtid="844424930133363" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133364" style="font-size: 10pt; color: blue; font-family: 'Courier New'">commit</span><span __designer:dtid="844424930133365" style="font-size: 10pt; color: gray; font-family: 'Courier New'">;</span></p> <p __designer:dtid="844424930133367" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133368" style="font-size: 10pt; font-family: 'Courier New'">go</span></p> <p __designer:dtid="844424930133369">And, as expected, the Service Broker responds immedeately with an error on our conversation because the message did not pass the XML payload validation:</p> <p __designer:dtid="844424930133370" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133371" style="font-size: 10pt; color: blue; font-family: 'Courier New'"><</span><span __designer:dtid="844424930133372" style="font-size: 10pt; color: maroon; font-family: 'Courier New'">Error</span><span __designer:dtid="844424930133373" style="font-size: 10pt; color: blue; font-family: 'Courier New'"> </span><span __designer:dtid="844424930133374" style="font-size: 10pt; color: red; font-family: 'Courier New'">xmlns</span><span __designer:dtid="844424930133375" style="font-size: 10pt; color: blue; font-family: 'Courier New'">=</span><span __designer:dtid="844424930133376" style="font-size: 10pt; font-family: 'Courier New'">&#8220;<span __designer:dtid="844424930133377" style="color: blue">http://schemas.microsoft.com/SQL/ServiceBroker/Error</span>&#8220;<span __designer:dtid="844424930133378" style="color: blue">></span></span></p> <p __designer:dtid="844424930133380" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133381" style="font-size: 10pt; color: blue; font-family: 'Courier New'"><span __designer:dtid="844424930133382">  </span><</span><span __designer:dtid="844424930133383" style="font-size: 10pt; color: maroon; font-family: 'Courier New'">Code</span><span __designer:dtid="844424930133384" style="font-size: 10pt; color: blue; font-family: 'Courier New'">></span><span __designer:dtid="844424930133385" style="font-size: 10pt; font-family: 'Courier New'">-9615<span __designer:dtid="844424930133386" style="color: blue"></</span><span __designer:dtid="844424930133387" style="color: maroon">Code</span><span __designer:dtid="844424930133388" style="color: blue">></span></span></p> <p __designer:dtid="844424930133390" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133391" style="font-size: 10pt; color: blue; font-family: 'Courier New'"><span __designer:dtid="844424930133392">  </span><</span><span __designer:dtid="844424930133393" style="font-size: 10pt; color: maroon; font-family: 'Courier New'">Description</span><span __designer:dtid="844424930133394" style="font-size: 10pt; color: blue; font-family: 'Courier New'">></span><span _\_designer:dtid="844424930133395" style="font-size: 10pt; font-family: 'Courier New'">A message of type &#8216;valid\_payload&#8217; failed XML validation on the target service.<span __designer:dtid="844424930133396">  </span>XML parsing: line 1, character 51, end tag does not match start tag This occurred in the message with Conversation ID &#8216;&#8230;&#8217;, Initiator: 1, and Message sequence number: 0.<span __designer:dtid="844424930133397" style="color: blue"></</span><span __designer:dtid="844424930133398" style="color: maroon">Description</span><span __designer:dtid="844424930133399" style="color: blue">></span></span></p> <p __designer:dtid="844424930133401" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133402" style="font-size: 10pt; color: blue; font-family: 'Courier New'"></</span><span __designer:dtid="844424930133403" style="font-size: 10pt; color: maroon; font-family: 'Courier New'">Error</span><span __designer:dtid="844424930133404" style="font-size: 10pt; color: blue; font-family: 'Courier New'">></span></p> <p __designer:dtid="844424930133405">So we were able to cope with the case of invalid XML, but how about other cases? What if the message is still valid XML, but has some invalid attributes? Ie. the payload <span __designer:dtid="844424930133406" style="font-size: 10pt; color: red; font-family: 'Courier New'">&#8216;<payload><entry id=&#8221;foobar&#8221; key=&#8221;A&#8221; value=&#8221;B&#8221;/></payload>&#8217;<span _\_designer:dtid="844424930133407" style="font-size: 12pt; color: #000000; font-family: Times New Roman">will pass the well\_formed_xml test, but will still cause the service to disable itslef, because &#8216;foobar&#8217; cannot be casted to int. You could raise the bar even further by specifying an XML schema for validation, but not all of us are so confident in our XML schema knowledge to be sure that we covered everything. And besides, there are binary messages too, XML payload is <em __designer:dtid="844424930133408">not</em> a requirement for Service Broker. The truth is that the severity of such trivial errors forcing the transaction to rollback is quite a burden on the application, since it means that pretty much any malformed message can disable a service. And there simply isn&#8217;t any buletproof defense against it.</span></span></p> <h2 __designer:dtid="844424930133409">Post Rollback corrective actions</h2> <p __designer:dtid="844424930133410">Many developers I talked with have been at this point already and realised that they simply cannot cover all the angles on this problem so they tried another approach: what if one rolls back, but then does some corrective action. Surely we could write some code in the catch block that remedies the problem, like dequeue the message and error the conversation immedeately, without trying to process it&#8217;s payload. Usually this looks something like the following, int he BEGIN CATCH block:</p> <p __designer:dtid="844424930133411" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133412" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133413">            </span><span __designer:dtid="844424930133414" style="color: green">&#8212; Test whether the transaction is uncommittable.</span></span></p> <p __designer:dtid="844424930133416" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133417" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133418">            </span><span __designer:dtid="844424930133419" style="color: blue">if</span> <span __designer:dtid="844424930133420" style="color: gray">(</span><span _\_designer:dtid="844424930133421" style="color: fuchsia">XACT\_STATE</span><span __designer:dtid="844424930133422" style="color: gray">())</span> <span __designer:dtid="844424930133423" style="color: gray">=</span> <span __designer:dtid="844424930133424" style="color: gray">&#8211;</span>1</span></p> <p __designer:dtid="844424930133426" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133427" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133428">            </span><span __designer:dtid="844424930133429" style="color: blue">begin</span></span></p> <p __designer:dtid="844424930133431" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133432" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133433">                  </span><span __designer:dtid="844424930133434" style="color: blue">rollback</span> <span __designer:dtid="844424930133435" style="color: blue">transaction</span><span __designer:dtid="844424930133436" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133438" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133439" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133440">                  </span><span __designer:dtid="844424930133441" style="color: green">&#8212; take corrective actions</span></span></p> <p __designer:dtid="844424930133443" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133444" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133445"> </span><span __designer:dtid="844424930133446">     </span><span __designer:dtid="844424930133447">            </span><span __designer:dtid="844424930133448" style="color: blue">declare</span> @error <span __designer:dtid="844424930133449" style="color: blue">int</span><span __designer:dtid="844424930133450" style="color: gray">,</span> @message <span __designer:dtid="844424930133451" style="color: blue">nvarchar</span><span __designer:dtid="844424930133452" style="color: gray">(</span>4000<span __designer:dtid="844424930133453" style="color: gray">);</span></span></p> <p __designer:dtid="844424930133455" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133456" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133457">                  </span><span __designer:dtid="844424930133458" style="color: blue">select</span> @error <span __designer:dtid="844424930133459" style="color: gray">=</span> <span _\_designer:dtid="844424930133460" style="color: fuchsia">ERROR\_NUMBER</span><span __designer:dtid="844424930133461" style="color: gray">(),</span> @message <span __designer:dtid="844424930133462" style="color: gray">=</span> <span _\_designer:dtid="844424930133463" style="color: fuchsia">ERROR\_MESSAGE</span><span __designer:dtid="844424930133464" style="color: gray">();</span></span></p> <p __designer:dtid="844424930133466" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133467" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133468">                  </span><span __designer:dtid="844424930133469" style="color: blue">begin</span> <span __designer:dtid="844424930133470" style="color: blue">transaction</span><span __designer:dtid="844424930133471" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133473" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133474" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133475">                  </span><span __designer:dtid="844424930133476" style="color: blue">receive</span> <span __designer:dtid="844424930133477" style="color: blue">top</span><span __designer:dtid="844424930133478" style="color: gray">(</span>1<span __designer:dtid="844424930133479" style="color: gray">)</span> @messageBody <span __designer:dtid="844424930133480" style="color: gray">=</span> message_body </span></p> <p __designer:dtid="844424930133482" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133483" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133484">                        </span><span __designer:dtid="844424930133485" style="color: blue">from</span> [target_queue]</span></p> <p __designer:dtid="844424930133487" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133488" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133489">                        </span><span __designer:dtid="844424930133490" style="color: blue">where</span> <span _\_designer:dtid="844424930133491" style="color: blue">conversation\_handle</span> <span __designer:dtid="844424930133492" style="color: gray">=</span> @handle<span __designer:dtid="844424930133493" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133495" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133496" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133497">                  </span><span __designer:dtid="844424930133498" style="color: blue">end</span> <span __designer:dtid="844424930133499" style="color: blue">conversation</span> <span __designer:dtid="844424930133500" style="color: blue">with</span> error <span __designer:dtid="844424930133501" style="color: gray">=</span> @error <span __designer:dtid="844424930133502" style="color: blue">description</span> <span __designer:dtid="844424930133503" style="color: gray">=</span> @message<span __designer:dtid="844424930133504" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133506" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133507" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133508">                  </span><span __designer:dtid="844424930133509" style="color: blue">commit</span><span __designer:dtid="844424930133510" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133512" style="margin: 0in 0in 0pt" class="MsoNormal"><span __designer:dtid="844424930133513" style="font-size: 10pt; font-family: 'Courier New'"><span __designer:dtid="844424930133514">            </span><span __designer:dtid="844424930133515" style="color: blue">end</span><span __designer:dtid="844424930133516" style="color: gray">;</span></span></p> <p __designer:dtid="844424930133517">&nbsp;</p> <p __designer:dtid="844424930133518">But this is riddled with problems. The moment the transaction was rollbed back, the code has absolutely no guarantee over the state of this conversation and its messages. Another instance of the activated procedure might had already picked up the very same message and tried to process it. This problem is true for any processing of this kind, it is not specific to Service Broker, but the typical Service Broker environment, with it&#8217;s activated procedures running in parallel and trying to grab the next unlocked message it is very likely to happen in production. What&#8217;s worst is that is is <em __designer:dtid="844424930133519">unlikely</em> to happen in the test development environement, unless the test environment matches the concurrency of the production environment.</p> <h2 __designer:dtid="844424930133520">Conclusions</h2> <p __designer:dtid="844424930133521">So it turns out error handling in Service Broker is a bit trickier than expected and presenting some challenges. Some recommendations stand valid:</p> <ul __designer:dtid="844424930133522"> <li __designer:dtid="844424930133523">Do use the BEGIN TRY/BEGIN CATCH blocks, they are simplifying the code tremendously</li> <li __designer:dtid="844424930133524">Use the Service Broker conversation semantics to represent business transactions, and use the END CONVERSATION &#8230; WITH ERROR to signal errors to the other service at the end of a conversation when you catch</li> <li __designer:dtid="844424930133525">Do harden your service broker contract as much as possible using XML validation schemas to catch malformed messages as early as possible, before they enter your application queues</li> </ul> <p __designer:dtid="844424930133526">But other thant this, dealing with errors and the problems caused by uncommittable transactions and its effects on Service Broker queues is by no means trivial, and is a subject I actually still looking for an acceptable answer.</p>